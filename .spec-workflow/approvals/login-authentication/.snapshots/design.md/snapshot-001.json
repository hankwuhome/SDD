{
  "id": "snapshot_1758786489726_rf8g7g8rn",
  "approvalId": "approval_1758786489680_tn1l3ldj2",
  "approvalTitle": "登入頁面功能設計文件",
  "version": 1,
  "timestamp": "2025-09-25T07:48:09.726Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\r\n\r\n## Overview\r\n\r\n登入頁面功能 (Login Authentication) 是 MOTP 雙因子驗證系統的核心認證入口，整合傳統的帳號密碼驗證與 TOTP 雙因子驗證。此設計遵循現有系統的架構模式，擴展既有的認證服務和前端元件，提供完整的多階段登入流程。\r\n\r\n系統採用前後端分離架構，前端使用 Angular 18 + Angular Material + Bootstrap，後端使用 .NET 8 Web API + Entity Framework Core。設計重點在於安全性、使用者體驗和與現有 MOTP 系統的無縫整合。\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n- **前端技術棧**: Angular 18 + TypeScript + Angular Material + Bootstrap，遵循現有專案標準\r\n- **後端架構**: .NET 8 Web API 三層式架構 (Controller-Service-Repository)，與現有 OTP 系統保持一致\r\n- **安全標準**: 實施 HTTPS、CORS、CSRF 保護、安全標頭，符合 NIST SP 800-63B 指南\r\n- **編碼規範**: 使用 UTF-8 編碼，繁體中文介面，遵循專案既定的命名和註解規範\r\n\r\n### Project Structure (structure.md)\r\n- **前端結構**: 遵循 `features/auth/pages` 模式，與現有 `bind-device`、`otp-verify` 元件保持一致\r\n- **後端分層**: 擴展現有的 `Controllers/`、`Services/`、`Repositories/`、`Models/` 結構\r\n- **共享服務**: 整合既有的 `OtpService`、`EncryptionService`、`UserRepository`\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n- **OtpService (Angular)**: 擴展現有服務添加登入相關 API 方法\r\n- **UserRepository (.NET)**: 利用現有使用者管理和帳號鎖定功能\r\n- **EncryptionService (.NET)**: 重用密碼雜湊和加密功能\r\n- **ApplicationDbContext**: 擴展現有資料庫上下文添加會話管理\r\n- **Angular Material 元件**: 重用現有的表單、卡片、載入指示器元件\r\n\r\n### Integration Points\r\n- **現有 OTP API**: 整合 `/api/OTP/verify` 端點進行 TOTP 驗證\r\n- **使用者管理系統**: 連接現有 `Users` 表和相關實體關係\r\n- **前端路由系統**: 擴展現有 `app.routes.ts` 添加登入相關路由\r\n- **備用驗證碼系統**: 整合現有 `BackupCodes` 表和相關服務\r\n\r\n## Architecture\r\n\r\n系統採用多階段認證架構，分為三個主要階段：帳號密碼驗證 → TOTP 驗證 → 會話建立。前端使用 Angular Signals 進行狀態管理，後端採用無狀態 API 設計，透過 JWT Token 管理使用者會話。\r\n\r\n### Modular Design Principles\r\n- **Single File Responsibility**: 登入元件專注於 UI 邏輯，認證服務專注於 API 互動，會話服務專注於狀態管理\r\n- **Component Isolation**: 登入頁面、TOTP 驗證、會話管理各自獨立，可單獨測試和維護\r\n- **Service Layer Separation**: 前端服務層 (AuthService) 封裝 HTTP 請求，後端服務層 (AuthService) 處理商業邏輯\r\n- **Utility Modularity**: 密碼驗證、會話管理、錯誤處理等功能模組化\r\n\r\n```mermaid\r\ngraph TD\r\n    A[登入頁面 LoginComponent] --> B[認證服務 AuthService]\r\n    B --> C[後端 AuthController]\r\n    C --> D[認證服務 AuthService.NET]\r\n    D --> E[使用者倉庫 UserRepository]\r\n    D --> F[OTP 服務 OTPService]\r\n    E --> G[資料庫 ApplicationDbContext]\r\n    F --> G\r\n    \r\n    H[TOTP 驗證頁面] --> B\r\n    I[會話服務 SessionService] --> J[JWT Token 管理]\r\n    B --> I\r\n    \r\n    K[路由守衛 AuthGuard] --> I\r\n    L[主頁面 HomeComponent] --> K\r\n```\r\n\r\n## Components and Interfaces\r\n\r\n### Frontend Components\r\n\r\n#### LoginComponent (Angular)\r\n- **Purpose:** 處理帳號密碼登入 UI 和表單驗證\r\n- **Interfaces:** \r\n  - `onLogin()`: 處理登入表單提交\r\n  - `navigateToTOTP()`: 導向 TOTP 驗證頁面\r\n- **Dependencies:** AuthService, Router, FormBuilder, MatSnackBar\r\n- **Reuses:** 現有的 Angular Material 表單元件、載入狀態管理模式\r\n\r\n#### TotpLoginComponent (Angular)\r\n- **Purpose:** 處理 TOTP 驗證階段的 UI\r\n- **Interfaces:** \r\n  - `verifyTOTP()`: 驗證 TOTP 驗證碼\r\n  - `useBackupCode()`: 切換到備用驗證碼模式\r\n- **Dependencies:** AuthService, OtpService, Router\r\n- **Reuses:** 現有的 `OtpVerifyComponent` 設計模式和樣式\r\n\r\n#### AuthService (Angular)\r\n- **Purpose:** 封裝前端認證相關的 HTTP 請求和狀態管理\r\n- **Interfaces:** \r\n  - `login(credentials)`: Observable<LoginResponse>\r\n  - `verifyTOTP(userId, code)`: Observable<VerifyResponse>\r\n  - `logout()`: void\r\n  - `getCurrentUser()`: Observable<User>\r\n- **Dependencies:** HttpClient, SessionService\r\n- **Reuses:** 現有的 `OtpService` 錯誤處理和 HTTP 請求模式\r\n\r\n#### SessionService (Angular)\r\n- **Purpose:** 管理使用者會話狀態和 JWT Token\r\n- **Interfaces:** \r\n  - `setSession(token, user)`: void\r\n  - `clearSession()`: void\r\n  - `isAuthenticated()`: boolean\r\n  - `getToken()`: string | null\r\n- **Dependencies:** 無 (獨立服務)\r\n- **Reuses:** 瀏覽器 localStorage API\r\n\r\n### Backend Components\r\n\r\n#### AuthController (.NET)\r\n- **Purpose:** 處理認證相關的 HTTP 請求\r\n- **Interfaces:** \r\n  - `POST /api/auth/login`: 帳號密碼驗證\r\n  - `POST /api/auth/verify-totp`: TOTP 驗證\r\n  - `POST /api/auth/logout`: 登出\r\n  - `GET /api/auth/profile`: 取得使用者資訊\r\n- **Dependencies:** IAuthService, ILogger\r\n- **Reuses:** 現有的 `OTPController` 結構和錯誤處理模式\r\n\r\n#### AuthService (.NET)\r\n- **Purpose:** 實現認證商業邏輯\r\n- **Interfaces:** \r\n  - `AuthenticateAsync(email, password)`: Task<AuthResult>\r\n  - `VerifyTOTPAsync(userId, code)`: Task<bool>\r\n  - `GenerateJWTAsync(user)`: Task<string>\r\n  - `ValidateSessionAsync(token)`: Task<User>\r\n- **Dependencies:** IUserRepository, IOTPService, IEncryptionService\r\n- **Reuses:** 現有的 `OTPService` TOTP 驗證邏輯\r\n\r\n#### SessionManager (.NET)\r\n- **Purpose:** 管理使用者會話和 JWT Token\r\n- **Interfaces:** \r\n  - `CreateSessionAsync(user)`: Task<string>\r\n  - `ValidateTokenAsync(token)`: Task<User>\r\n  - `RevokeSessionAsync(token)`: Task\r\n- **Dependencies:** IConfiguration (JWT 設定)\r\n- **Reuses:** 現有的 JWT 相關配置\r\n\r\n## Data Models\r\n\r\n### LoginRequest (前端/後端共用)\r\n```typescript\r\ninterface LoginRequest {\r\n  email: string;           // 使用者電子郵件\r\n  password: string;        // 使用者密碼\r\n  rememberMe?: boolean;    // 記住登入狀態 (可選)\r\n}\r\n```\r\n\r\n### LoginResponse (前端/後端共用)\r\n```typescript\r\ninterface LoginResponse {\r\n  success: boolean;        // 登入是否成功\r\n  requiresTOTP: boolean;   // 是否需要 TOTP 驗證\r\n  userId?: string;         // 使用者 ID (需要 TOTP 時)\r\n  token?: string;          // JWT Token (完整認證後)\r\n  user?: UserInfo;         // 使用者基本資訊\r\n  errorMessage?: string;   // 錯誤訊息\r\n}\r\n```\r\n\r\n### TOTPVerifyRequest (前端/後端共用)\r\n```typescript\r\ninterface TOTPVerifyRequest {\r\n  userId: string;          // 使用者 ID\r\n  code: string;            // TOTP 驗證碼或備用驗證碼\r\n  isBackupCode?: boolean;  // 是否為備用驗證碼\r\n}\r\n```\r\n\r\n### SessionInfo (.NET)\r\n```csharp\r\npublic class SessionInfo\r\n{\r\n    public Guid UserId { get; set; }           // 使用者 ID\r\n    public string Email { get; set; }          // 使用者信箱\r\n    public DateTime LoginAt { get; set; }      // 登入時間\r\n    public DateTime ExpiresAt { get; set; }    // 過期時間\r\n    public string IpAddress { get; set; }      // 登入 IP\r\n    public string UserAgent { get; set; }      // 使用者代理\r\n}\r\n```\r\n\r\n### AuthResult (.NET)\r\n```csharp\r\npublic class AuthResult\r\n{\r\n    public bool IsSuccess { get; set; }        // 認證是否成功\r\n    public User User { get; set; }             // 使用者物件\r\n    public string ErrorMessage { get; set; }   // 錯誤訊息\r\n    public int RemainingAttempts { get; set; } // 剩餘嘗試次數\r\n    public DateTime? LockedUntil { get; set; } // 帳號鎖定到期時間\r\n}\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n\r\n1. **帳號密碼錯誤**\r\n   - **Handling:** 記錄失敗嘗試，超過限制後鎖定帳號\r\n   - **User Impact:** 顯示錯誤訊息和剩餘嘗試次數\r\n\r\n2. **帳號已鎖定**\r\n   - **Handling:** 檢查鎖定狀態和到期時間\r\n   - **User Impact:** 顯示帳號鎖定訊息和解鎖時間\r\n\r\n3. **TOTP 驗證失敗**\r\n   - **Handling:** 允許重新輸入，記錄失敗次數\r\n   - **User Impact:** 顯示驗證失敗訊息，提供備用驗證碼選項\r\n\r\n4. **會話過期**\r\n   - **Handling:** 清除前端會話狀態，重導向登入頁面\r\n   - **User Impact:** 顯示會話過期提醒，要求重新登入\r\n\r\n5. **網路連線問題**\r\n   - **Handling:** 實施重試機制，顯示連線狀態\r\n   - **User Impact:** 顯示連線問題提醒，提供重試選項\r\n\r\n6. **伺服器內部錯誤**\r\n   - **Handling:** 記錄詳細錯誤日誌，回傳通用錯誤訊息\r\n   - **User Impact:** 顯示友善的錯誤訊息，避免洩露敏感資訊\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n\r\n#### 前端測試\r\n- **AuthService**: 測試 HTTP 請求、錯誤處理、狀態管理\r\n- **SessionService**: 測試 Token 儲存、驗證、清除功能\r\n- **LoginComponent**: 測試表單驗證、使用者互動、導航邏輯\r\n- **TotpLoginComponent**: 測試 TOTP 驗證流程、備用驗證碼切換\r\n\r\n#### 後端測試\r\n- **AuthController**: 測試 API 端點、請求驗證、回應格式\r\n- **AuthService**: 測試認證邏輯、密碼驗證、TOTP 整合\r\n- **SessionManager**: 測試 JWT 產生、驗證、撤銷功能\r\n\r\n### Integration Testing\r\n\r\n#### 前後端整合\r\n- **完整登入流程**: 測試從帳號密碼到 TOTP 驗證的完整流程\r\n- **API 整合**: 測試前端服務與後端 API 的資料交換\r\n- **錯誤處理整合**: 測試各種錯誤情況的端到端處理\r\n\r\n#### 資料庫整合\r\n- **使用者認證**: 測試資料庫查詢、密碼驗證、帳號鎖定\r\n- **會話管理**: 測試會話資料的儲存和查詢\r\n- **稽核記錄**: 測試登入事件的記錄和查詢\r\n\r\n### End-to-End Testing\r\n\r\n#### 使用者場景測試\r\n- **成功登入流程**: 完整的帳號密碼 + TOTP 驗證流程\r\n- **錯誤處理流程**: 各種錯誤情況的使用者體驗測試\r\n- **安全性測試**: 帳號鎖定、會話管理、權限控制測試\r\n- **跨瀏覽器測試**: 確保在不同瀏覽器中的相容性\r\n\r\n#### 效能測試\r\n- **並發登入**: 測試多使用者同時登入的系統效能\r\n- **負載測試**: 測試高負載情況下的系統穩定性\r\n- **回應時間**: 測試各階段認證的回應時間是否符合需求 ",
  "fileStats": {
    "size": 10579,
    "lines": 259,
    "lastModified": "2025-09-25T07:47:59.434Z"
  },
  "comments": []
}